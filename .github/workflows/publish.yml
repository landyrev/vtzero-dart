name: Publish

on:
  workflow_run:
    workflows: ["Release"]
    types:
      - completed

jobs:
  publish:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      id-token: write # Required for authentication using OIDC
      contents: read
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          # Get the latest tag that matches v* pattern
          TAG_NAME=$(git describe --tags --match 'v*' --abbrev=0)
          if [ -z "$TAG_NAME" ]; then
            echo "Error: No tag matching v* pattern found"
            exit 1
          fi
          VERSION=${TAG_NAME#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Found tag: $TAG_NAME, version: $VERSION"

      - name: Download native binaries archive from release
        uses: actions/github-script@v7
        with:
          script: |
            const tagName = '${{ steps.version.outputs.tag_name }}';
            const version = '${{ steps.version.outputs.version }}';
            
            // Get the release for this tag
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const release = releases.data.find(r => r.tag_name === tagName);
            if (!release) {
              throw new Error(`Release not found for tag ${tagName}`);
            }
            
            // Find the native binaries asset
            const asset = release.assets.find(a => 
              a.name === `native-binaries-${version}.tar.gz`
            );
            
            if (!asset) {
              throw new Error(`Native binaries archive not found in release ${tagName}`);
            }
            
            // Download the asset
            const response = await github.rest.repos.getReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              asset_id: asset.id,
              headers: {
                accept: 'application/octet-stream'
              }
            });
            
            const fs = require('fs');
            const path = require('path');
            const archivePath = path.join(process.cwd(), `native-binaries-${version}.tar.gz`);
            fs.writeFileSync(archivePath, Buffer.from(response.data));
            
            console.log(`Downloaded archive: ${archivePath}`);

      - name: Extract native binaries archive
        run: |
          mkdir -p lib/native
          tar -xzf native-binaries-${{ steps.version.outputs.version }}.tar.gz -C lib/native
          echo "Extracted native binaries to lib/native"

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.0'
          channel: 'stable'
          cache: true

      - name: Publish to pub.dev
        run: |
          flutter pub publish --dry-run
          flutter pub publish

